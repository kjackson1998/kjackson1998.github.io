import e from"./spaceTraders.mjs";const{Vector:t}=window.Matter,s={};class o{static copyEvent(e){return{currentTarget:e.currentTarget,button:e.button,clientX:e.clientX,clientY:e.clientY,deltaX:e.deltaX,deltaY:e.deltaY}}windowLoad(e){const n=document.getElementById("canvas"),r=n.getContext("2d"),l=n.parentElement.getBoundingClientRect();n.width=l.width,n.height=l.height,n.isMouseDown=!1,n.lastMouse=null,n.worldStack=[],n.gameOptions={},n.addEventListener("mousedown",(e=>this.canvasMouseDown(e))),n.addEventListener("mouseup",(e=>this.canvasMouseUp(e))),n.addEventListener("mousemove",(e=>this.canvasMouseMove(e))),n.addEventListener("wheel",(e=>this.canvasMouseWheel(e))),n.addEventListener("contextmenu",(e=>this.canvasMouseRightClick(e)));new ResizeObserver((e=>{for(let t of e)t.target==n.parentElement&&this.canvasResize(n)})).observe(n.parentElement),window.addEventListener("keypress",(e=>this.windowKeyPress(e)));let h=document.getElementById("starColorSelector");h.querySelectorAll(".button").forEach((e=>e.addEventListener("click",c))),a(h);let p=document.getElementById("authKeyInput");if(window.localStorage){const e=i(window.localStorage.getItem("authKey"));e&&(s.spaceTradersApi.authKey=e,p.value=e)}p.addEventListener("input",(e=>{const t=i(e.currentTarget.value);t&&(s.spaceTradersApi.authKey=t,window.localStorage.setItem("authKey",t))})),s.gameState.run().then((()=>console.log("Game state exited."))).catch((e=>console.error(`Game state error ${JSON.stringify(e)}`))),requestAnimationFrame((()=>u(r)));const y=o.copyEvent(e);w().then((e=>{const s=new C(e.map((e=>new S(e))),n.gameOptions),o=t.create(150,150);s.setFullView(o,n),d(n,s),this.canvasMouseMove(y)}))}windowKeyPress(e){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"KeyS"==e.code){const e=document.querySelector(".mainControlSide");e.classList.contains("hidden")?e.classList.remove("hidden"):e.classList.add("hidden")}}canvasMouseClick(e){const t=e.currentTarget;t.world&&t.world.click(e)}canvasMouseRightClick(e){e.preventDefault();const t=e.currentTarget;t.world&&t.world.rightClick(e)}canvasMouseDown(e){const t=e.currentTarget,s=this.eventMousePos(e);0===e.button&&(t.isMouseDown=Date.now(),t.lastMouse=s,t.mouseMoved=!1)}canvasMouseUp(e){const t=e.currentTarget;0===e.button&&(Date.now()-t.isMouseDown<200&&this.canvasMouseClick(e),t.isMouseDown=0,t.lastMouse=null)}eventMousePos(e){if(null==e.clientX)return t.create(e.clientX,e.clientY);const s=e.currentTarget.getBoundingClientRect();return t.create(e.clientX-s.left,e.clientY-s.top)}canvasMouseWheel(e){const s=e.currentTarget,o=this.eventMousePos(e);if(null!=s.world){const n=s.world.screenToWorld(o);for(let t=0;t<Math.abs(e.deltaY);t++)e.deltaY<0?s.world.scale*=1.001:s.world.scale*=.999;const i=s.world.screenToWorld(o);s.world.offset=t.sub(s.world.offset,t.sub(i,n))}}canvasMouseMove(e){const s=this.eventMousePos(e),o=e.currentTarget;if(o.isMouseDown){if(null!=o.world){const e=o.world.screenToWorld(o.lastMouse),n=o.world.screenToWorld(s);o.world.offset=t.sub(o.world.offset,t.sub(n,e))}o.lastMouse=s,o.mouseMoved=!0}if(null!=o.world){let e=Number.MAX_VALUE,n=null;for(const i of o.world.renderables){const r=t.magnitudeSquared(t.sub(s,i.getScreenPos(o.world)));if(r<e){const t=i.getScreenHitRadius();r<t*t&&(e=r,n=i)}}null!=n?(document.getElementById("statusBar").innerText=n.getTooltipText(),o.hoverRenderable=n):(document.getElementById("statusBar").innerText="",o.hoverRenderable=null)}}canvasResize(e){const s=e.parentElement.getBoundingClientRect();if(e.width=s.width,e.height=s.height,null==e.world)return;const o=e.world.screenToWorld(t.create(0,0)),n=e.world.screenToWorld(t.create(0,0));e.world.offset=t.add(e.world.offset,t.sub(n,o))}}class n{constructor(){this.ships=[]}async run(){for(;;)await this.update(),await new Promise((e=>setTimeout(e,5e3)))}async update(){const e=await s.spaceTradersApi.fetchMyShips();this.ships=e,s.shipListUx.updateShips(e)}}function i(e){function t(e){return function(e){const t=4-e.length%4;return t<4?e+"=".repeat(t):e}(e.replace(/-/g,"+").replace(/_/g,"/"))}try{if(!e)throw"No auth token";const s=function(e){const s=e.split("."),o={header:JSON.parse(atob(t(s[0]))),payload:JSON.parse(atob(t(s[1]))),sig:t(s[2])};if((o.sig?.length??0)<=0)throw"Invalid JWT - no signature";return o}(e),o=s.payload.identifier;if((o?.length??0)<=0)throw"Invalid JWT - no identifier";if("agent-token"!=s.payload.sub)throw"Invalid JWT - not an agent token";return console.log("Hello, "+o+"!"),e}catch(e){console.log("Hello, anonymous!")}return null}function r(e){return(e=e??0).toFixed(0)+"s"}class l{constructor(){this.shipListShipNameTemplate=document.getElementById("shipListShipNameTemplate"),this.shipListShipCargoTemplate=document.getElementById("shipListShipCargoTemplate"),this.shipListShipFuelTemplate=document.getElementById("shipListShipFuelTemplate"),this.shipListShipCooldownTemplate=document.getElementById("shipListShipCooldownTemplate"),this.shipListElement=document.getElementById("shipList")}updateShips(e){let t=[...this.shipListElement.children].filter((e=>null!=e.shipSymbol));for(const e of t)e.delMe=!0;for(const s of e){let e=t.filter((e=>e.shipSymbol==s.symbol));e.forEach((e=>e.delMe=!1)),e.length<=0&&(e=this.addShipElements(s)),this.updateShip(s,e)}for(const e of t.filter((e=>e.delMe)))this.shipListElement.removeChild(e)}addShipElements(e){let t=document.importNode(shipListShipNameTemplate.content,!0);this.shipListElement.appendChild(t),t=this.shipListElement.lastElementChild,t.shipSymbol=e.symbol;let s=document.importNode(shipListShipCargoTemplate.content,!0);this.shipListElement.appendChild(s),s=this.shipListElement.lastElementChild,s.shipSymbol=e.symbol;let o=document.importNode(shipListShipFuelTemplate.content,!0);this.shipListElement.appendChild(o),o=this.shipListElement.lastElementChild,o.shipSymbol=e.symbol;let n=document.importNode(shipListShipCooldownTemplate.content,!0);return this.shipListElement.appendChild(n),n=this.shipListElement.lastElementChild,n.shipSymbol=e.symbol,[t,s,o,n]}updateShip(e,t){t.forEach((t=>{let s;s=t.querySelector(".shipListShipName"),s&&(s.innerText=e.symbol),s=t.querySelector(".shipListShipCargoUnits"),s&&(s.innerText=e.cargo.units),s=t.querySelector(".shipListShipCargoCapacity"),s&&(s.innerText=e.cargo.capacity),s=t.querySelector(".shipListShipFuelCurrent"),s&&(s.innerText=e.fuel.current),s=t.querySelector(".shipListShipFuelCapacity"),s&&(s.innerText=e.fuel.capacity),s=t.querySelector(".shipListShipCooldownRemaining"),s&&(s.innerText=r(e.cooldown.remainingSeconds)),s=t.querySelector(".shipListShipCooldownTotal"),s&&(s.innerText=r(e.cooldown.totalSeconds))}))}}function a(e){if(!window.localStorage)return;let t=window.localStorage.getItem("starColor");t||(t="type"),Array.from(e.querySelectorAll(".button")).find((e=>e.innerText==t)).click()}function c(e){canvas.gameOptions.starColor=e.currentTarget.innerText,e.currentTarget.parentNode.querySelectorAll(".button").forEach((e=>e.classList.remove("selected"))),e.currentTarget.classList.add("selected"),window.localStorage&&window.localStorage.setItem("starColor",e.currentTarget.innerText)}function d(e,t){e.world&&e.worldStack.push(e.world),e.world=t}function h(e){0!=e.worldStack.length&&(e.world=e.worldStack.pop())}function u(e){requestAnimationFrame((()=>u(e))),null!=e.canvas.world?e.canvas.world.render(e):e.clearRect(0,0,e.canvas.width,e.canvas.height)}function p(e){const s=e.canvas.width,o=e.canvas.height;y(e,t.create(0,0)),y(e,t.create(s,0)),y(e,t.create(0,o)),y(e,t.create(s,o)),y(e,t.create(s/2,o/2)),y(e,t.create(s-1,o/2)),y(e,t.create(s/2,o-1))}function y(e,t){t.x+=.5,t.y+=.5,e.beginPath(),e.arc(t.x,t.y,13,0,2*Math.PI),e.moveTo(t.x-20,t.y),e.lineTo(t.x+20,t.y),e.moveTo(t.x+20,t.y),e.lineTo(t.x-20,t.y),e.moveTo(t.x,t.y-20),e.lineTo(t.x,t.y+20),e.moveTo(t.x,t.y+20),e.lineTo(t.x,t.y-20),e.closePath(),e.strokeWidth=1,e.strokeStyle=L(255,0,255),e.stroke()}const m={systemTypes:{BLUE_STAR:{fillColor:L(0,0,128)},RED_STAR:{fillColor:L(64,0,0)},ORANGE_STAR:{fillColor:L(128,64,0)},WHITE_DWARF:{fillColor:L(192,192,192)},BLACK_HOLE:{strokeColor:L(255,255,255),fillColor:L(0,0,0)},UNSTABLE:{fillColor:L(128,0,128)},NEUTRON_STAR:{fillColor:L(128,128,255)},HYPERGIANT:{fillColor:L(255,128,128)},YOUNG_STAR:{fillColor:L(0,64,0)}},factions:{QUANTUM:{fillColor:L(128,0,0)},DOMINION:{fillColor:L(0,128,0)},LORDS:{fillColor:L(0,0,128)},GALACTIC:{fillColor:L(128,128,0)},COBALT:{fillColor:L(128,0,128)},VOID:{fillColor:L(0,128,128)},AEGIS:{fillColor:L(64,32,32)},COSMIC:{fillColor:L(32,64,32)},OBSIDIAN:{fillColor:L(32,32,64)},ASTRO:{fillColor:L(64,64,32)},SOLITARY:{fillColor:L(64,32,64)},ECHO:{fillColor:L(32,64,64)}}};async function w(){const e=await fetch("data/systems.json.gz");if(404==e.status)throw"Could not load systems.";const t=new DecompressionStream("gzip"),s=e.body.pipeThrough(t).getReader(),o=new TextDecoder;let n="",i=!1;for(;!i;){const{value:e,done:t}=await s.read();e&&(n+=o.decode(e)),i=t}return JSON.parse(n)}async function f(e){const t=await s.spaceTradersApi.callApi(`systems/${e}`);if(200!=t.status)throw"Could not load system data: "+await t.text();const o=(await t.json()).data,n=await s.spaceTradersApi.callApiPaged(`systems/${o.symbol}/waypoints`);if(200!=t.status)throw`Could not load ${e} data: `+await t.text();o.waypoints=n.pagedData;let i={[o.symbol]:o};return o.waypoints.forEach((e=>i[e.symbol]=e)),Object.values(i).forEach((e=>e.children=[])),o.waypoints.forEach((e=>{let t=e.orbits;null==t&&(t=o.symbol),e.parent=i[t],i[t].children.push(e)})),o}class g{getAbsoluteWorldPos(){throw"Not implemented"}getScreenPos(e){throw"Not implemented"}render(e,t,s){throw"Not implemented"}getScreenHitRadius(){throw"Not implemented"}getTooltipText(){throw"Not implemented"}}class S extends g{static radius=4;constructor(e,t){super(),this.system=e,this.asOrigin=t}getAbsoluteWorldPos(){return this.asOrigin?t.create(0,0):t.create(this.system.x,this.system.y)}getScreenPos(e){return this.asOrigin?e.worldToScreen(t.create(0,0)):e.worldToScreen(t.create(this.system.x,this.system.y))}getScreenHitRadius(){return 4*S.radius}getTooltipText(){return`${this.system.symbol} ${this.system.type}`}render(e,t,s){if(0==t)return!0;const o=this.getScreenPos(s);e.beginPath(),e.arc(o.x,o.y,S.radius,0,2*Math.PI),e.closePath(),e.strokeWidth=2;const n=s.getOption("starColor");"type"==n?this.setStyleBySystemType(e):"faction"==n?this.setStyleBySystemFaction(e):"waypoints"==n?this.setStyleBySystemWaypoints(e):"jumpgates"==n&&this.setStyleBySystemJumpgates(e),e.stroke(),e.fill()}setStyleBySystemJumpgates(e){e.strokeStyle=A(255,255,255,.5);const t=this.system.waypoints.some((e=>"JUMP_GATE"==e.type));e.fillStyle=t?L(48,128,48):L(0,0,0)}setStyleBySystemWaypoints(e){e.strokeStyle=A(255,255,255,.5),e.fillStyle=L(0,0,0);let t=this.system.waypoints?.length??0;if(t<=0)return;t=Math.min(t,10);const s=t/10*90;e.fillStyle=`hsl(220, ${s}%, ${.7*s}%)`}setStyleBySystemType(e){e.strokeStyle=A(255,255,255,.1);const t=m.systemTypes[this.system.type];t?(e.fillStyle=t.fillColor,t.strokeColor&&(e.strokeStyle=t.strokeColor)):(e.fillStyle=L(255,255,255),console.log("Unknown system type: "+system.type))}setStyleBySystemFaction(e){if(e.strokeStyle=A(255,255,255,1),this.system.factions?.length>1)throw"multiple factions: "+JSON.stringify(this.system);const t=this.system.factions[0]?.symbol??null;if(t){const s=m.factions[t];s?e.fillStyle=s.fillColor:(e.fillStyle=L(255,255,255),console.log("Unknown system faction: "+t))}else e.strokeStyle=A(255,255,255,.2),e.fillStyle=A(0,0,0,0)}}class T extends g{static radius=6;constructor(e){super(),this.waypoint=e}getAbsoluteWorldPos(){return t.create(this.waypoint.x,this.waypoint.y)}getScreenPos(e){let s=this.waypoint;for(;null!=s.parent;)s=s.parent;if(this.waypoint.parent==s)return e.worldToScreen(t.create(this.waypoint.x,this.waypoint.y));if(null!=this.waypoint.parent&&this.waypoint.parent!=s){const s=e.worldToScreen(t.create(this.waypoint.parent.x,this.waypoint.parent.y)),o=this.waypoint.parent.children.indexOf(this.waypoint),n=-o*(2*Math.PI/8.5),i=4*T.radius+o*T.radius*1,r=t.mult(t.create(Math.cos(n),Math.sin(n)),i);return t.add(s,r)}return e.worldToScreen(t.create(this.waypoint.x,this.waypoint.y))}getScreenHitRadius(){return 4*T.radius}getTooltipText(){return`${this.waypoint.symbol} ${this.waypoint.type} [${this.waypoint.traits.map((e=>e.name)).join(", ")}]`}render(e,s,o){const n=this.getScreenPos(o);let i=this.waypoint;for(;null!=i.parent;)i=i.parent;if(0==s&&null!=this.waypoint.parent){let s;e.beginPath(),s=this.waypoint.parent==i?o.worldToScreen(t.create(0,0)):o.worldToScreen(t.create(this.waypoint.parent.x,this.waypoint.parent.y)),e.arc(s.x,s.y,t.magnitude(t.sub(n,s)),0,2*Math.PI),e.strokeWidth=1,e.strokeStyle=L(64,64,64),e.closePath(),this.waypoint.parent==i&&e.setLineDash([10,5]),e.stroke(),e.setLineDash([])}if(0==s)return!0;e.beginPath(),e.arc(n.x,n.y,T.radius,0,2*Math.PI),e.closePath(),e.strokeWidth=2,e.strokeStyle=L(255,255,255),this.waypoint.type,e.fillStyle=L(0,0,255),e.stroke(),e.fill()}}async function M(e){await new Promise((t=>setTimeout(t,e)))}class v{constructor(e,s){this.renderables=e,this.options={global:s},this.scale=1,this.offset=t.create(0,0),this.computeWorldBounds()}computeWorldBounds(){this.worldMin=t.create(Number.MAX_VALUE,Number.MAX_VALUE),this.worldMax=t.create(Number.MIN_VALUE,Number.MIN_VALUE);for(const e of this.renderables){const t=e.getAbsoluteWorldPos();this.worldMin.x=Math.min(this.worldMin.x,t.x),this.worldMax.x=Math.max(this.worldMax.x,t.x),this.worldMin.y=Math.min(this.worldMin.y,t.y),this.worldMax.y=Math.max(this.worldMax.y,t.y)}this.worldMin.x==Number.MAX_VALUE&&(this.worldMin.x=-1),this.worldMin.y==Number.MAX_VALUE&&(this.worldMin.y=-1),this.worldMax.x==Number.MIN_VALUE&&(this.worldMax.x=1),this.worldMax.y==Number.MIN_VALUE&&(this.worldMax.y=1)}setFullView(e,s){this.offset=t.create(0,0),this.scale=1;const o=t.create(0,0),n=t.create(s.width,s.height),i=t.add(o,e),r=t.sub(n,e),l=t.sub(r,i),a=t.sub(this.worldMax,this.worldMin),c=l.x/a.x,d=l.y/a.y;this.scale=Math.min(c,d);const h=t.add(i,t.div(t.sub(r,i),2)),u=t.add(this.worldMin,t.div(t.sub(this.worldMax,this.worldMin),2));this.offset=t.sub(u,this.screenToWorld(h))}screenToWorld(e){return e=t.div(e,this.scale),e=t.add(e,this.offset)}worldToScreen(e){return e=t.sub(e,this.offset),e=t.mult(e,this.scale)}render(e){e.clearRect(0,0,e.canvas.width,e.canvas.height);let t=0,s=this.renderables??[];do{let o=s;s=[];for(const n of o)n.render(e,t,this)&&s.push(n);t++}while(s.length>0)}getOption(e){return this.options[e]??this.options.global[e]}click(e){}rightClick(e){}}class b extends v{rightClick(e){h(e.currentTarget),s.events.canvasMouseMove(e)}}class C extends v{click(e){const n=e.currentTarget;if(null==n.hoverRenderable)return;n.worldCache=n.worldCache??{};const i=n.worldCache[n.hoverRenderable.system.symbol];if(i)return d(n,i),void s.events.canvasMouseMove(e);const r=o.copyEvent(e);f(n.hoverRenderable.system.symbol).then((e=>{const o=[];o.push(new S(e,!0)),function e(t){t.children.forEach((t=>{o.push(new T(t)),e(t)}))}(e);const i=new b(o,n.gameOptions),l=t.create(150,150);i.setFullView(l,n),n.worldCache[e.symbol]=i,d(n,i),s.events.canvasMouseMove(r)}))}}async function x(e){const t=(new TextEncoder).encode(e),s=await crypto.subtle.digest("SHA-256",t);return Array.from(new Uint8Array(s))}function E(e){const t=e.slice(0,4);let s=0;for(let e=0;e<t.length;e++)s=s<<8|t[e];return s}function L(e,t,s){return`rgb(${e},${t},${s})`}function A(e,t,s,o){return`rgb(${e},${t},${s},${o})`}s.spaceTradersApi=new e((function(...e){return window.fetch(...e)})),s.shipListUx=new l,s.events=new o,s.gameState=new n,window.addEventListener("load",(e=>s.events.windowLoad(e)));