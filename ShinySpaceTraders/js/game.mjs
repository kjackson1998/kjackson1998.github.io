import t from"./spaceTraders.mjs";const{Vector:e}=window.Matter,o={};function i(i){o.spaceTradersApi=new t((function(...t){return window.fetch(...t)})),o.gameState=new s,o.shipListUx=new l;const r=document.getElementById("canvas"),a=r.getContext("2d"),p=r.parentElement.getBoundingClientRect();r.width=p.width,r.height=p.height,r.isMouseDown=!1,r.lastMouse=null,r.worldStack=[],r.gameOptions={},r.addEventListener("mousedown",y),r.addEventListener("mouseup",w),r.addEventListener("mousemove",g),r.addEventListener("wheel",S),r.addEventListener("contextmenu",m);new ResizeObserver((t=>{for(let e of t)e.target==r.parentElement&&h(r)})).observe(r.parentElement),window.addEventListener("keypress",u);let f=this.document.getElementById("starColorSelector");f.querySelectorAll(".button").forEach((t=>t.addEventListener("click",d))),c(f);let C=this.document.getElementById("authKeyInput");if(window.localStorage){const t=n(window.localStorage.getItem("authKey"));t&&(o.spaceTradersApi.authKey=t,C.value=t)}C.addEventListener("input",(t=>{const e=n(t.currentTarget.value);e&&(o.spaceTradersApi.authKey=e,window.localStorage.setItem("authKey",e))})),o.gameState.run().then((()=>{throw"Game state exited."})),requestAnimationFrame((()=>b(a)));const x=U(i);M().then((t=>{const o=new O(t.map((t=>new v(t))),r.gameOptions),i=e.create(150,150);o.setFullView(i,r),T(r,o),g(x)}))}window.addEventListener("load",i);class s{constructor(){this.ships=[]}async run(){for(;;)await this.update(),await new Promise((t=>setTimeout(t,5e3)))}async update(){const t=await o.spaceTradersApi.fetchMyShips();this.ships=t,o.shipListUx.updateShips(t)}}function n(t){function e(t){const e=t.replace(/-/g,"+").replace(/_/g,"/");return e+"==".slice(0,(3-e.length%4)%3)}try{if(!t)throw"No auth token";const o=function(t){const o=t.split("."),i={header:JSON.parse(atob(e(o[0]))),payload:JSON.parse(atob(e(o[1]))),sig:e(o[2])};if((i.sig?.length??0)<=0)throw"Invalid JWT - no signature";return i}(t),i=o.payload.identifier;if((i?.length??0)<=0)throw"Invalid JWT - no identifier";if("agent-token"!=o.payload.sub)throw"Invalid JWT - not an agent token";return console.log("Hello, "+i+"!"),t}catch(t){console.log("Hello, anonymous!")}return null}function r(t){return(t=t??0).toFixed(0)+"s"}class l{constructor(){this.shipListShipNameTemplate=window.document.getElementById("shipListShipNameTemplate"),this.shipListShipCargoTemplate=window.document.getElementById("shipListShipCargoTemplate"),this.shipListShipFuelTemplate=window.document.getElementById("shipListShipFuelTemplate"),this.shipListShipCooldownTemplate=window.document.getElementById("shipListShipCooldownTemplate"),this.shipListElement=window.document.getElementById("shipList")}updateShips(t){let e=[...this.shipListElement.children].filter((t=>null!=t.shipSymbol));for(const t of e)t.delMe=!0;for(const o of t){let t=e.filter((t=>t.shipSymbol==o.symbol));t.forEach((t=>t.delMe=!1)),t.length<=0&&(t=this.addShipElements(o)),this.updateShip(o,t)}for(const t of e.filter((t=>t.delMe)))this.shipListElement.removeChild(t)}addShipElements(t){let e=window.document.importNode(shipListShipNameTemplate.content,!0);this.shipListElement.appendChild(e),e=this.shipListElement.lastElementChild,e.shipSymbol=t.symbol;let o=window.document.importNode(shipListShipCargoTemplate.content,!0);this.shipListElement.appendChild(o),o=this.shipListElement.lastElementChild,o.shipSymbol=t.symbol;let i=window.document.importNode(shipListShipFuelTemplate.content,!0);this.shipListElement.appendChild(i),i=this.shipListElement.lastElementChild,i.shipSymbol=t.symbol;let s=window.document.importNode(shipListShipCooldownTemplate.content,!0);return this.shipListElement.appendChild(s),s=this.shipListElement.lastElementChild,s.shipSymbol=t.symbol,[e,o,i,s]}updateShip(t,e){e.forEach((e=>{let o;o=e.querySelector(".shipListShipName"),o&&(o.innerText=t.symbol),o=e.querySelector(".shipListShipCargoUnits"),o&&(o.innerText=t.cargo.units),o=e.querySelector(".shipListShipCargoCapacity"),o&&(o.innerText=t.cargo.capacity),o=e.querySelector(".shipListShipFuelCurrent"),o&&(o.innerText=t.fuel.current),o=e.querySelector(".shipListShipFuelCapacity"),o&&(o.innerText=t.fuel.capacity),o=e.querySelector(".shipListShipCooldownRemaining"),o&&(o.innerText=r(t.cooldown.remainingSeconds)),o=e.querySelector(".shipListShipCooldownTotal"),o&&(o.innerText=r(t.cooldown.totalSeconds))}))}}function a(){let t=this.document.getElementById("shipListShipNameTemplate"),e=this.document.getElementById("shipListShipCargoTemplate"),o=this.document.getElementById("shipListShipFuelTemplate"),i=this.document.getElementById("shipListShipCooldownTemplate"),s=this.document.getElementById("shipList");for(let n=0;n<15;n++){let r=this.document.importNode(t.content,!0);r.querySelector(".shipListShipName").innerText=`Ship ${n}`,s.appendChild(r);let l=this.document.importNode(e.content,!0);l.querySelector(".shipListShipCargoUnits").innerText="0",l.querySelector(".shipListShipCargoCapacity").innerText="100",s.appendChild(l);let a=this.document.importNode(o.content,!0);a.querySelector(".shipListShipFuelCurrent").innerText="100",a.querySelector(".shipListShipFuelCapacity").innerText="9999",s.appendChild(a);let c=this.document.importNode(i.content,!0);c.querySelector(".shipListShipCooldownRemaining").innerText="0",c.querySelector(".shipListShipCooldownTotal").innerText="0",s.appendChild(c)}}function c(t){if(!window.localStorage)return;let e=window.localStorage.getItem("starColor");e||(e="type"),Array.from(t.querySelectorAll(".button")).find((t=>t.innerText==e)).click()}function d(t){canvas.gameOptions.starColor=t.currentTarget.innerText,t.currentTarget.parentNode.querySelectorAll(".button").forEach((t=>t.classList.remove("selected"))),t.currentTarget.classList.add("selected"),window.localStorage&&window.localStorage.setItem("starColor",t.currentTarget.innerText)}function h(t){const o=t.parentElement.getBoundingClientRect();if(t.width=o.width,t.height=o.height,null==t.world)return;const i=t.world.screenToWorld(e.create(0,0)),s=t.world.screenToWorld(e.create(0,0));t.world.offset=e.add(t.world.offset,e.sub(s,i))}function u(t){if("INPUT"!=document.activeElement.tagName&&"TEXTAREA"!=document.activeElement.tagName&&"KeyS"==t.code){const t=this.document.querySelector(".mainControlSide");t.classList.contains("hidden")?t.classList.remove("hidden"):t.classList.add("hidden")}}function p(t){const e=t.currentTarget;e.world&&e.world.click(t)}async function m(t){t.preventDefault();const e=t.currentTarget;e.world&&e.world.rightClick(t)}function y(t){const e=t.currentTarget,o=f(t);0===t.button&&(e.isMouseDown=Date.now(),e.lastMouse=o,e.mouseMoved=!1)}function w(t){const e=t.currentTarget;0===t.button&&(Date.now()-e.isMouseDown<200&&p(t),e.isMouseDown=0,e.lastMouse=null)}function f(t){if(null==t.clientX)return e.create(t.clientX,t.clientY);const o=t.currentTarget.getBoundingClientRect();return e.create(t.clientX-o.left,t.clientY-o.top)}function S(t){const o=t.currentTarget,i=f(t);if(null!=o.world){const s=o.world.screenToWorld(i);for(let e=0;e<Math.abs(t.deltaY);e++)t.deltaY<0?o.world.scale*=1.001:o.world.scale*=.999;const n=o.world.screenToWorld(i);o.world.offset=e.sub(o.world.offset,e.sub(n,s))}}function g(t){const o=f(t),i=t.currentTarget;if(i.isMouseDown){if(null!=i.world){const t=i.world.screenToWorld(i.lastMouse),s=i.world.screenToWorld(o);i.world.offset=e.sub(i.world.offset,e.sub(s,t))}i.lastMouse=o,i.mouseMoved=!0}if(null!=i.world){let t=Number.MAX_VALUE,s=null;for(const n of i.world.renderables){const r=e.magnitudeSquared(e.sub(o,n.getScreenPos(i.world)));if(r<t){const e=n.getScreenHitRadius();r<e*e&&(t=r,s=n)}}null!=s?(document.getElementById("statusBar").innerText=s.getTooltipText(),i.hoverRenderable=s):(document.getElementById("statusBar").innerText="",i.hoverRenderable=null)}}function T(t,e){t.world&&t.worldStack.push(t.world),t.world=e}function C(t){0!=t.worldStack.length&&(t.world=t.worldStack.pop())}function b(t){requestAnimationFrame((()=>b(t))),null!=t.canvas.world?t.canvas.world.render(t):t.clearRect(0,0,t.canvas.width,t.canvas.height)}function x(t){const o=t.canvas.width,i=t.canvas.height;E(t,e.create(0,0)),E(t,e.create(o,0)),E(t,e.create(0,i)),E(t,e.create(o,i)),E(t,e.create(o/2,i/2)),E(t,e.create(o-1,i/2)),E(t,e.create(o/2,i-1))}function E(t,e){e.x+=.5,e.y+=.5,t.beginPath(),t.arc(e.x,e.y,13,0,2*Math.PI),t.moveTo(e.x-20,e.y),t.lineTo(e.x+20,e.y),t.moveTo(e.x+20,e.y),t.lineTo(e.x-20,e.y),t.moveTo(e.x,e.y-20),t.lineTo(e.x,e.y+20),t.moveTo(e.x,e.y+20),t.lineTo(e.x,e.y-20),t.closePath(),t.strokeWidth=1,t.strokeStyle=q(255,0,255),t.stroke()}const L={systemTypes:{BLUE_STAR:{fillColor:q(0,0,128)},RED_STAR:{fillColor:q(64,0,0)},ORANGE_STAR:{fillColor:q(128,64,0)},WHITE_DWARF:{fillColor:q(192,192,192)},BLACK_HOLE:{strokeColor:q(255,255,255),fillColor:q(0,0,0)},UNSTABLE:{fillColor:q(128,0,128)},NEUTRON_STAR:{fillColor:q(128,128,255)},HYPERGIANT:{fillColor:q(255,128,128)},YOUNG_STAR:{fillColor:q(0,64,0)}},factions:{QUANTUM:{fillColor:q(128,0,0)},DOMINION:{fillColor:q(0,128,0)},LORDS:{fillColor:q(0,0,128)},GALACTIC:{fillColor:q(128,128,0)},COBALT:{fillColor:q(128,0,128)},VOID:{fillColor:q(0,128,128)},AEGIS:{fillColor:q(64,32,32)},COSMIC:{fillColor:q(32,64,32)},OBSIDIAN:{fillColor:q(32,32,64)},ASTRO:{fillColor:q(64,64,32)},SOLITARY:{fillColor:q(64,32,64)},ECHO:{fillColor:q(32,64,64)}}};async function M(){const t=await fetch("data/systems.json.gz");if(404==t.status)throw"Could not load systems.";const e=new DecompressionStream("gzip"),o=t.body.pipeThrough(e).getReader(),i=new TextDecoder;let s="",n=!1;for(;!n;){const{value:t,done:e}=await o.read();t&&(s+=i.decode(t)),n=e}return JSON.parse(s)}async function A(t){const e=await o.spaceTradersApi.callApi(`systems/${t}`);if(200!=e.status)throw"Could not load system data: "+await e.text();const i=(await e.json()).data,s=await o.spaceTradersApi.callApiPaged(`systems/${i.symbol}/waypoints`);if(200!=e.status)throw`Could not load ${t} data: `+await e.text();i.waypoints=s.pagedData;let n={[i.symbol]:i};return i.waypoints.forEach((t=>n[t.symbol]=t)),Object.values(n).forEach((t=>t.children=[])),i.waypoints.forEach((t=>{let e=t.orbits;null==e&&(e=i.symbol),t.parent=n[e],n[e].children.push(t)})),i}class N{getAbsoluteWorldPos(){throw"Not implemented"}getScreenPos(t){throw"Not implemented"}render(t,e,o){throw"Not implemented"}getScreenHitRadius(){throw"Not implemented"}getTooltipText(){throw"Not implemented"}}class v extends N{static radius=4;constructor(t,e){super(),this.system=t,this.asOrigin=e}getAbsoluteWorldPos(){return this.asOrigin?e.create(0,0):e.create(this.system.x,this.system.y)}getScreenPos(t){return this.asOrigin?t.worldToScreen(e.create(0,0)):t.worldToScreen(e.create(this.system.x,this.system.y))}getScreenHitRadius(){return 4*v.radius}getTooltipText(){return`${this.system.symbol} ${this.system.type}`}render(t,e,o){if(0==e)return!0;const i=this.getScreenPos(o);t.beginPath(),t.arc(i.x,i.y,v.radius,0,2*Math.PI),t.closePath(),t.strokeWidth=2;const s=o.getOption("starColor");"type"==s?this.setStyleBySystemType(t):"faction"==s?this.setStyleBySystemFaction(t):"waypoints"==s?this.setStyleBySystemWaypoints(t):"jumpgates"==s&&this.setStyleBySystemJumpgates(t),t.stroke(),t.fill()}setStyleBySystemJumpgates(t){t.strokeStyle=D(255,255,255,.5);const e=this.system.waypoints.some((t=>"JUMP_GATE"==t.type));t.fillStyle=e?q(48,128,48):q(0,0,0)}setStyleBySystemWaypoints(t){t.strokeStyle=D(255,255,255,.5),t.fillStyle=q(0,0,0);let e=this.system.waypoints?.length??0;if(e<=0)return;e=Math.min(e,10);const o=e/10*90;t.fillStyle=`hsl(220, ${o}%, ${.7*o}%)`}setStyleBySystemType(t){t.strokeStyle=D(255,255,255,.1);const e=L.systemTypes[this.system.type];e?(t.fillStyle=e.fillColor,e.strokeColor&&(t.strokeStyle=e.strokeColor)):(t.fillStyle=q(255,255,255),console.log("Unknown system type: "+system.type))}setStyleBySystemFaction(t){if(t.strokeStyle=D(255,255,255,1),this.system.factions?.length>1)throw"multiple factions: "+JSON.stringify(this.system);const e=this.system.factions[0]?.symbol??null;if(e){const o=L.factions[e];o?t.fillStyle=o.fillColor:(t.fillStyle=q(255,255,255),console.log("Unknown system faction: "+e))}else t.strokeStyle=D(255,255,255,.2),t.fillStyle=D(0,0,0,0)}}class I extends N{static radius=6;constructor(t){super(),this.waypoint=t}getAbsoluteWorldPos(){return e.create(this.waypoint.x,this.waypoint.y)}getScreenPos(t){let o=this.waypoint;for(;null!=o.parent;)o=o.parent;if(this.waypoint.parent==o)return t.worldToScreen(e.create(this.waypoint.x,this.waypoint.y));if(null!=this.waypoint.parent&&this.waypoint.parent!=o){const o=t.worldToScreen(e.create(this.waypoint.parent.x,this.waypoint.parent.y)),i=this.waypoint.parent.children.indexOf(this.waypoint),s=-i*(2*Math.PI/8.5),n=4*I.radius+i*I.radius*1,r=e.mult(e.create(Math.cos(s),Math.sin(s)),n);return e.add(o,r)}return t.worldToScreen(e.create(this.waypoint.x,this.waypoint.y))}getScreenHitRadius(){return 4*I.radius}getTooltipText(){return`${this.waypoint.symbol} ${this.waypoint.type} [${this.waypoint.traits.map((t=>t.name)).join(", ")}]`}render(t,o,i){const s=this.getScreenPos(i);let n=this.waypoint;for(;null!=n.parent;)n=n.parent;if(0==o&&null!=this.waypoint.parent){let o;t.beginPath(),o=this.waypoint.parent==n?i.worldToScreen(e.create(0,0)):i.worldToScreen(e.create(this.waypoint.parent.x,this.waypoint.parent.y)),t.arc(o.x,o.y,e.magnitude(e.sub(s,o)),0,2*Math.PI),t.strokeWidth=1,t.strokeStyle=q(64,64,64),t.closePath(),this.waypoint.parent==n&&t.setLineDash([10,5]),t.stroke(),t.setLineDash([])}if(0==o)return!0;t.beginPath(),t.arc(s.x,s.y,I.radius,0,2*Math.PI),t.closePath(),t.strokeWidth=2,t.strokeStyle=q(255,255,255),this.waypoint.type,t.fillStyle=q(0,0,255),t.stroke(),t.fill()}}async function k(t){await new Promise((e=>setTimeout(e,t)))}class B{constructor(t,o){this.renderables=t,this.options={global:o},this.scale=1,this.offset=e.create(0,0),this.computeWorldBounds()}computeWorldBounds(){this.worldMin=e.create(Number.MAX_VALUE,Number.MAX_VALUE),this.worldMax=e.create(Number.MIN_VALUE,Number.MIN_VALUE);for(const t of this.renderables){const e=t.getAbsoluteWorldPos();this.worldMin.x=Math.min(this.worldMin.x,e.x),this.worldMax.x=Math.max(this.worldMax.x,e.x),this.worldMin.y=Math.min(this.worldMin.y,e.y),this.worldMax.y=Math.max(this.worldMax.y,e.y)}this.worldMin.x==Number.MAX_VALUE&&(this.worldMin.x=-1),this.worldMin.y==Number.MAX_VALUE&&(this.worldMin.y=-1),this.worldMax.x==Number.MIN_VALUE&&(this.worldMax.x=1),this.worldMax.y==Number.MIN_VALUE&&(this.worldMax.y=1)}setFullView(t,o){this.offset=e.create(0,0),this.scale=1;const i=e.create(0,0),s=e.create(o.width,o.height),n=e.add(i,t),r=e.sub(s,t),l=e.sub(r,n),a=e.sub(this.worldMax,this.worldMin),c=l.x/a.x,d=l.y/a.y;this.scale=Math.min(c,d);const h=e.add(n,e.div(e.sub(r,n),2)),u=e.add(this.worldMin,e.div(e.sub(this.worldMax,this.worldMin),2));this.offset=e.sub(u,this.screenToWorld(h))}screenToWorld(t){return t=e.div(t,this.scale),t=e.add(t,this.offset)}worldToScreen(t){return t=e.sub(t,this.offset),t=e.mult(t,this.scale)}render(t){t.clearRect(0,0,t.canvas.width,t.canvas.height);let e=0,o=this.renderables??[];do{let i=o;o=[];for(const s of i)s.render(t,e,this)&&o.push(s);e++}while(o.length>0)}getOption(t){return this.options[t]??this.options.global[t]}click(t){}rightClick(t){}}class R extends B{rightClick(t){C(t.currentTarget),g(t)}}class O extends B{click(t){const o=t.currentTarget;if(null==o.hoverRenderable)return;o.worldCache=o.worldCache??{};const i=o.worldCache[o.hoverRenderable.system.symbol];if(i)return T(o,i),void g(t);const s=U(t);A(o.hoverRenderable.system.symbol).then((t=>{const i=[];i.push(new v(t,!0)),function t(e){e.children.forEach((e=>{i.push(new I(e)),t(e)}))}(t);const n=new R(i,o.gameOptions),r=e.create(150,150);n.setFullView(r,o),o.worldCache[t.symbol]=n,T(o,n),g(s)}))}}async function P(t){const e=(new TextEncoder).encode(t),o=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(o))}function W(t){const e=t.slice(0,4);let o=0;for(let t=0;t<e.length;t++)o=o<<8|e[t];return o}function U(t){return{currentTarget:t.currentTarget,button:t.button,clientX:t.clientX,clientY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY}}function q(t,e,o){return`rgb(${t},${e},${o})`}function D(t,e,o,i){return`rgb(${t},${e},${o},${i})`}