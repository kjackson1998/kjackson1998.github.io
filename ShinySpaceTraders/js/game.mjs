const{Vector:t}=window.Matter;function e(t){function e(t){const e=t.replace(/-/g,"+").replace(/_/g,"/");return e+"==".slice(0,(3-e.length%4)%3)}try{if(!t)throw"No auth token";const o=function(t){const o=t.split("."),n={header:JSON.parse(atob(e(o[0]))),payload:JSON.parse(atob(e(o[1]))),sig:e(o[2])};if((n.sig?.length??0)<=0)throw"Invalid JWT - no signature";return n}(t),n=o.payload.identifier;if((n?.length??0)<=0)throw"Invalid JWT - no identifier";if("agent-token"!=o.payload.sub)throw"Invalid JWT - not an agent token";return console.log("Hello, "+n+"!"),t}catch(t){console.log(t)}return null}function o(t){return(t=t??0).toFixed(0)+"s"}function n(t){canvas.gameOptions.starColor=t.currentTarget.innerText,t.currentTarget.parentNode.querySelectorAll(".button").forEach((t=>t.classList.remove("selected"))),t.currentTarget.classList.add("selected"),window.localStorage&&window.localStorage.setItem("starColor",t.currentTarget.innerText)}function s(e){const o=e.parentElement.getBoundingClientRect();if(e.width=o.width,e.height=o.height,null==e.world)return;const n=e.world.screenToWorld(t.create(0,0)),s=e.world.screenToWorld(t.create(0,0));e.world.offset=t.add(e.world.offset,t.sub(s,n))}function r(t){if("KeyS"==t.code){const t=this.document.querySelector(".mainControlSide");t.classList.contains("hidden")?t.classList.remove("hidden"):t.classList.add("hidden")}}async function i(t){t.preventDefault();!function(t){if(0==t.worldStack.length)return;t.world=t.worldStack.pop()}(t.currentTarget),u(t)}function l(t){const e=t.currentTarget,o=c(t);0===t.button&&(e.isMouseDown=Date.now(),e.lastMouse=o,e.mouseMoved=!1)}function a(t){const e=t.currentTarget;0===t.button&&(Date.now()-e.isMouseDown<200&&function(t){const e=t.currentTarget;null!=e.hoverRenderable&&e.world&&e.world.click(t)}(t),e.isMouseDown=0,e.lastMouse=null)}function c(e){if(null==e.clientX)return t.create(e.clientX,e.clientY);const o=e.currentTarget.getBoundingClientRect();return t.create(e.clientX-o.left,e.clientY-o.top)}function d(e){const o=e.currentTarget,n=c(e);if(null!=o.world){const s=o.world.screenToWorld(n);for(let t=0;t<Math.abs(e.deltaY);t++)e.deltaY<0?o.world.scale*=1.001:o.world.scale*=.999;const r=o.world.screenToWorld(n);o.world.offset=t.sub(o.world.offset,t.sub(r,s))}}function u(e){const o=c(e),n=e.currentTarget;if(n.isMouseDown){if(null!=n.world){const e=n.world.screenToWorld(n.lastMouse),s=n.world.screenToWorld(o);n.world.offset=t.sub(n.world.offset,t.sub(s,e))}n.lastMouse=o,n.mouseMoved=!0}if(null!=n.world){let e=Number.MAX_VALUE,s=null;for(const r of n.world.renderables){const i=t.magnitudeSquared(t.sub(o,r.getScreenPos(n.world)));if(i<e){const t=r.getScreenHitRadius();i<t*t&&(e=i,s=r)}}null!=s?(document.getElementById("statusBar").innerText=s.getTooltipText(),n.hoverRenderable=s):(document.getElementById("statusBar").innerText="",n.hoverRenderable=null)}}function h(t,e){t.world&&t.worldStack.push(t.world),t.world=e}function y(t){requestAnimationFrame((()=>y(t))),null!=t.canvas.world?t.canvas.world.render(t):t.clearRect(0,0,t.canvas.width,t.canvas.height)}window.addEventListener("load",(function(c){const p=document.getElementById("canvas"),f=p.getContext("2d"),g=p.parentElement.getBoundingClientRect();p.width=g.width,p.height=g.height,p.isMouseDown=!1,p.lastMouse=null,p.worldStack=[],p.gameOptions={},p.addEventListener("mousedown",l),p.addEventListener("mouseup",a),p.addEventListener("mousemove",u),p.addEventListener("wheel",d),p.addEventListener("contextmenu",i);new ResizeObserver((t=>{for(let e of t)e.target==p.parentElement&&s(p)})).observe(p.parentElement),window.addEventListener("keypress",r);let S=this.document.getElementById("starColorSelector");S.querySelectorAll(".button").forEach((t=>t.addEventListener("click",n))),function(t){if(!window.localStorage)return;let e=window.localStorage.getItem("starColor");e||(e="type");Array.from(t.querySelectorAll(".button")).find((t=>t.innerText==e)).click()}(S);let x=this.document.getElementById("authKeyInput");if(window.localStorage){const t=e(window.localStorage.getItem("authKey"));t&&(w.authKey=t,x.value=t)}x.addEventListener("input",(t=>{const o=e(t.currentTarget.value);o&&(w.authKey=o,window.localStorage.setItem("authKey",o))})),w.fetchMyShips().then((t=>{t.forEach((t=>function(t){let e=window.document.getElementById("shipListShipNameTemplate"),n=window.document.getElementById("shipListShipCargoTemplate"),s=window.document.getElementById("shipListShipFuelTemplate"),r=window.document.getElementById("shipListShipCooldownTemplate"),i=window.document.getElementById("shipList"),l=window.document.importNode(e.content,!0);l.querySelector(".shipListShipName").innerText=t.symbol,i.appendChild(l);let a=window.document.importNode(n.content,!0);a.querySelector(".shipListShipCargoUnits").innerText=t.cargo.units,a.querySelector(".shipListShipCargoCapacity").innerText=t.cargo.capacity,i.appendChild(a);let c=window.document.importNode(s.content,!0);c.querySelector(".shipListShipFuelCurrent").innerText=t.fuel.current,c.querySelector(".shipListShipFuelCapacity").innerText=t.fuel.capacity,i.appendChild(c);let d=window.document.importNode(r.content,!0);d.querySelector(".shipListShipCooldownRemaining").innerText=o(t.cooldown.remainingSeconds),d.querySelector(".shipListShipCooldownTotal").innerText=o(t.cooldown.totalSeconds),i.appendChild(d)}(t)))})),requestAnimationFrame((()=>y(f)));const C=b(c);w.fetchGalaxy().then((e=>{const o=new T(e.map((t=>new m(t))),p.gameOptions),n=t.create(150,150);o.setFullView(n,p),h(p,o),u(C)}))}));class w{static constants={systemTypes:{BLUE_STAR:{fillColor:x(0,0,128)},RED_STAR:{fillColor:x(64,0,0)},ORANGE_STAR:{fillColor:x(128,64,0)},WHITE_DWARF:{fillColor:x(192,192,192)},BLACK_HOLE:{strokeColor:x(255,255,255),fillColor:x(0,0,0)},UNSTABLE:{fillColor:x(128,0,128)},NEUTRON_STAR:{fillColor:x(128,128,255)},HYPERGIANT:{fillColor:x(255,128,128)},YOUNG_STAR:{fillColor:x(0,64,0)}},factions:{QUANTUM:{fillColor:x(128,0,0)},DOMINION:{fillColor:x(0,128,0)},LORDS:{fillColor:x(0,0,128)},GALACTIC:{fillColor:x(128,128,0)},COBALT:{fillColor:x(128,0,128)},VOID:{fillColor:x(0,128,128)},AEGIS:{fillColor:x(64,32,32)},COSMIC:{fillColor:x(32,64,32)},OBSIDIAN:{fillColor:x(32,32,64)},ASTRO:{fillColor:x(64,64,32)},SOLITARY:{fillColor:x(64,32,64)},ECHO:{fillColor:x(32,64,64)}}};static baseUrl="https://api.spacetraders.io/v2/";static authKey=null;static fixBase(t){try{return new URL(t),t}catch(e){return w.baseUrl+t}}static async callApiPaged(t,e,o){t=this.fixBase(t);const n=[];let s,r,i=1;do{if((t=new URL(t)).searchParams.set("limit",20),t.searchParams.set("page",i),t=t.toString(),r=await w.callApi(t,e,o),200!=r.status)return r.pagedData=n,r;s=await r.json(),n.push(...s.data),i++}while(s.meta.page<s.meta.total/s.meta.limit);return r.pagedData=n,r}static async callApi(t,e,o){t=this.fixBase(t);const n={Accept:"application/json"};w.authKey&&(n.Authorization="Bearer "+w.authKey);const s={headers:n};return e&&(s.method=e),o&&(s.body=JSON.stringify(o)),await fetch(t,s)}static async fetchGalaxy(){const t=await fetch("data/systems.json.gz");if(404==t.status)throw"Could not load systems.";const e=new DecompressionStream("gzip"),o=t.body.pipeThrough(e).getReader(),n=new TextDecoder;let s="",r=!1;for(;!r;){const{value:t,done:e}=await o.read();t&&(s+=n.decode(t)),r=e}return JSON.parse(s)}static async fetchMyShips(){const t=await w.callApiPaged("my/ships");if(200!=t.status)throw"Could not load my ships: "+await t.text();return t.pagedData}static async fetchSystem(t){const e=await w.callApi(`systems/${t}`);if(200!=e.status)throw"Could not load system data: "+await e.text();const o=(await e.json()).data,n=await w.callApiPaged(`systems/${o.symbol}/waypoints`);if(200!=e.status)throw`Could not load ${t} data: `+await e.text();o.waypoints=n.pagedData;let s={[o.symbol]:o};return o.waypoints.forEach((t=>s[t.symbol]=t)),Object.values(s).forEach((t=>t.children=[])),o.waypoints.forEach((t=>{let e=t.orbits;null==e&&(e=o.symbol),t.parent=s[e],s[e].children.push(t)})),o}}class p{getAbsoluteWorldPos(){throw"Not implemented"}getScreenPos(t){throw"Not implemented"}render(t,e,o){throw"Not implemented"}getScreenHitRadius(){throw"Not implemented"}getTooltipText(){throw"Not implemented"}}class m extends p{static radius=4;constructor(t,e){super(),this.system=t,this.asOrigin=e}getAbsoluteWorldPos(){return this.asOrigin?t.create(0,0):t.create(this.system.x,this.system.y)}getScreenPos(e){return this.asOrigin?e.worldToScreen(t.create(0,0)):e.worldToScreen(t.create(this.system.x,this.system.y))}getScreenHitRadius(){return 4*m.radius}getTooltipText(){return`${this.system.symbol} ${this.system.type}`}render(t,e,o){if(0==e)return!0;const n=this.getScreenPos(o);t.beginPath(),t.arc(n.x,n.y,m.radius,0,2*Math.PI),t.closePath(),t.strokeWidth=2;const s=o.getOption("starColor");"type"==s?this.setStyleBySystemType(t):"faction"==s?this.setStyleBySystemFaction(t):"waypoints"==s?this.setStyleBySystemWaypoints(t):"jumpgates"==s&&this.setStyleBySystemJumpgates(t),t.stroke(),t.fill()}setStyleBySystemJumpgates(t){t.strokeStyle=C(255,255,255,.5);const e=this.system.waypoints.some((t=>"JUMP_GATE"==t.type));t.fillStyle=e?x(48,128,48):x(0,0,0)}setStyleBySystemWaypoints(t){t.strokeStyle=C(255,255,255,.5);const e=this.system.waypoints?.length??0;t.fillStyle=e<=0?x(0,0,0):e<=3?x(16,32,16):e<=9?x(32,64,32):x(48,128,48)}setStyleBySystemType(t){t.strokeStyle=C(255,255,255,.1);const e=w.constants.systemTypes[this.system.type];e?(t.fillStyle=e.fillColor,e.strokeColor&&(t.strokeStyle=e.strokeColor)):(t.fillStyle=x(255,255,255),console.log("Unknown system type: "+system.type))}setStyleBySystemFaction(t){if(t.strokeStyle=C(255,255,255,1),this.system.factions?.length>1)throw"multiple factions: "+JSON.stringify(this.system);const e=this.system.factions[0]?.symbol??null;if(e){const o=w.constants.factions[e];o?t.fillStyle=o.fillColor:(t.fillStyle=x(255,255,255),console.log("Unknown system faction: "+e))}else t.strokeStyle=C(255,255,255,.2),t.fillStyle=C(0,0,0,0)}}class f extends p{static radius=6;constructor(t){super(),this.waypoint=t}getAbsoluteWorldPos(){return t.create(this.waypoint.x,this.waypoint.y)}getScreenPos(e){let o=this.waypoint;for(;null!=o.parent;)o=o.parent;if(this.waypoint.parent==o)return e.worldToScreen(t.create(this.waypoint.x,this.waypoint.y));if(null!=this.waypoint.parent&&this.waypoint.parent!=o){const o=e.worldToScreen(t.create(this.waypoint.parent.x,this.waypoint.parent.y)),n=this.waypoint.parent.children.indexOf(this.waypoint),s=-n*(2*Math.PI/8.5),r=4*f.radius+n*f.radius*1,i=t.mult(t.create(Math.cos(s),Math.sin(s)),r);return t.add(o,i)}return e.worldToScreen(t.create(this.waypoint.x,this.waypoint.y))}getScreenHitRadius(){return 4*f.radius}getTooltipText(){return`${this.waypoint.symbol} ${this.waypoint.type} [${this.waypoint.traits.map((t=>t.name)).join(", ")}]`}render(e,o,n){const s=this.getScreenPos(n);let r=this.waypoint;for(;null!=r.parent;)r=r.parent;if(0==o&&null!=this.waypoint.parent){let o;e.beginPath(),o=this.waypoint.parent==r?n.worldToScreen(t.create(0,0)):n.worldToScreen(t.create(this.waypoint.parent.x,this.waypoint.parent.y)),e.arc(o.x,o.y,t.magnitude(t.sub(s,o)),0,2*Math.PI),e.strokeWidth=1,e.strokeStyle=x(64,64,64),e.closePath(),this.waypoint.parent==r&&e.setLineDash([10,5]),e.stroke(),e.setLineDash([])}if(0==o)return!0;e.beginPath(),e.arc(s.x,s.y,f.radius,0,2*Math.PI),e.closePath(),e.strokeWidth=2,e.strokeStyle=x(255,255,255),this.waypoint.type,e.fillStyle=x(0,0,255),e.stroke(),e.fill()}}class g{constructor(e,o){this.renderables=e,this.options={global:o},this.scale=1,this.offset=t.create(0,0),this.computeWorldBounds()}computeWorldBounds(){this.worldMin=t.create(Number.MAX_VALUE,Number.MAX_VALUE),this.worldMax=t.create(Number.MIN_VALUE,Number.MIN_VALUE);for(const t of this.renderables){const e=t.getAbsoluteWorldPos();this.worldMin.x=Math.min(this.worldMin.x,e.x),this.worldMax.x=Math.max(this.worldMax.x,e.x),this.worldMin.y=Math.min(this.worldMin.y,e.y),this.worldMax.y=Math.max(this.worldMax.y,e.y)}this.worldMin.x==Number.MAX_VALUE&&(this.worldMin.x=-1),this.worldMin.y==Number.MAX_VALUE&&(this.worldMin.y=-1),this.worldMax.x==Number.MIN_VALUE&&(this.worldMax.x=1),this.worldMax.y==Number.MIN_VALUE&&(this.worldMax.y=1)}setFullView(e,o){this.offset=t.create(0,0),this.scale=1;const n=t.create(0,0),s=t.create(o.width,o.height),r=t.add(n,e),i=t.sub(s,e),l=t.sub(i,r),a=t.sub(this.worldMax,this.worldMin),c=l.x/a.x,d=l.y/a.y;this.scale=Math.min(c,d);const u=t.add(r,t.div(t.sub(i,r),2)),h=t.add(this.worldMin,t.div(t.sub(this.worldMax,this.worldMin),2));this.offset=t.sub(h,this.screenToWorld(u))}screenToWorld(e){return e=t.div(e,this.scale),e=t.add(e,this.offset)}worldToScreen(e){return e=t.sub(e,this.offset),e=t.mult(e,this.scale)}render(t){t.clearRect(0,0,t.canvas.width,t.canvas.height);let e=0,o=this.renderables??[];do{let n=o;o=[];for(const s of n)s.render(t,e,this)&&o.push(s);e++}while(o.length>0)}getOption(t){return this.options[t]??this.options.global[t]}click(t){}}class S extends g{}class T extends g{click(e){const o=e.currentTarget;if(null==o.hoverRenderable)return;o.worldCache=o.worldCache??{};const n=o.worldCache[o.hoverRenderable.system.symbol];if(n)return h(o,n),void u(e);const s=b(e);w.fetchSystem(o.hoverRenderable.system.symbol).then((e=>{const n=[];n.push(new m(e,!0)),function t(e){e.children.forEach((e=>{n.push(new f(e)),t(e)}))}(e);const r=new S(n,o.gameOptions),i=t.create(150,150);r.setFullView(i,o),o.worldCache[e.symbol]=r,h(o,r),u(s)}))}}function b(t){return{currentTarget:t.currentTarget,button:t.button,clientX:t.clientX,clientY:t.clientY,deltaX:t.deltaX,deltaY:t.deltaY}}function x(t,e,o){return`rgb(${t},${e},${o})`}function C(t,e,o,n){return`rgb(${t},${e},${o},${n})`}