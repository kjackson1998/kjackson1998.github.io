export default class t{constructor(t){this.baseUrl="https://api.spacetraders.io/v2/",this.authKey=null,this.rateRemaining=2,this.rateResetAt=null,this.fetch=t}fixBase(t){try{return new URL(t),t}catch(a){return this.baseUrl+t}}async callApiPaged(t,a,e){t=this.fixBase(t);const s=[];let i,n,r=1;do{if((t=new URL(t)).searchParams.set("limit",20),t.searchParams.set("page",r),t=t.toString(),n=await this.callApi(t,a,e),200!=n.status)return n.pagedData=s,n;i=await n.json(),s.push(...i.data),r++}while(i.meta.page<i.meta.total/i.meta.limit);return n.pagedData=s,n}async callApi(t,a,e,s=!1){t=this.fixBase(t);const i={Accept:"application/json"};this.authKey&&(i.Authorization="Bearer "+this.authKey);const n={headers:i};for(a&&(n.method=a),e&&(n.body=JSON.stringify(e));;){if(s&&this.rateRemaining<=0){const t=Date.now();if(t<this.rateResetAt){const a=this.rateResetAt-t;await new Promise((t=>setTimeout(t,a)))}}const a=await this.fetch(t,n);if(this.rateRemaining=parseInt(a.headers.get("x-ratelimit-remaining")),this.rateResetAt=new Date(a.headers.get("x-ratelimit-reset")),429!=a.status)return a;console.log("429: "+(this.rateResetAt-Date.now())),s=!0}}async fetchMyShips(){const t=await this.callApiPaged("my/ships");if(200!=t.status)throw"Could not load my ships: "+await t.text();return t.pagedData}async fetchSystem(t){const a=await this.callApi(`systems/${t}`);if(200!=a.status)throw"Could not load system data: "+await a.text();return(await a.json()).data}async fetchWaypoints(t){const a=await this.callApiPaged(`systems/${system.symbol}/waypoints`);if(200!=systemResponse.status)throw`Could not load ${t} data: `+await systemResponse.text();return a.pagedData}}