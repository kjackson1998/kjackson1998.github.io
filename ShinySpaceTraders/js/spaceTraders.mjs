export default class t{constructor(t){this.baseUrl="https://api.spacetraders.io/v2/",this.authKey=null,this.rateRemaining=2,this.rateResetAt=null,this.fetch=t}fixBase(t){try{return new URL(t),t}catch(a){return this.baseUrl+t}}async callApiPaged(t,a,s){t=this.fixBase(t);const e=[];let i,n,o=1;do{if((t=new URL(t)).searchParams.set("limit",20),t.searchParams.set("page",o),t=t.toString(),n=await this.callApi(t,a,s),200!=n.status)return n.pagedData=e,n;i=await n.json(),e.push(...i.data),o++}while(i.meta.page<i.meta.total/i.meta.limit);return n.pagedData=e,n}async callApi(t,a,s,e=!1){t=this.fixBase(t);const i={Accept:"application/json"};this.authKey&&(i.Authorization="Bearer "+this.authKey);const n={headers:i};for(a&&(n.method=a),s&&(n.body=JSON.stringify(s));;){if(e&&this.rateRemaining<=0){const t=Date.now();if(t<this.rateResetAt){const a=this.rateResetAt-t;await new Promise((t=>setTimeout(t,a)))}}const a=await this.fetch(t,n);if(this.rateRemaining=parseInt(a.headers.get("x-ratelimit-remaining")),this.rateResetAt=new Date(a.headers.get("x-ratelimit-reset")),429!=a.status){if(401==a.status){const t=await a.json();throw console.log(t),console.log(t.error.message),t}return a}console.log("429: "+(this.rateResetAt-Date.now())),e=!0}}async fetchMyShips(){const t=await this.callApiPaged("my/ships");if(200!=t.status)throw"Could not load my ships: "+await t.text();return t.pagedData}async fetchSystem(t){const a=await this.callApi(`systems/${t}`);if(200!=a.status)throw"Could not load system data: "+await a.text();return(await a.json()).data}async fetchWaypoints(t){const a=await this.callApiPaged(`systems/${system.symbol}/waypoints`);if(200!=systemResponse.status)throw`Could not load ${t} data: `+await systemResponse.text();return a.pagedData}}